<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada School - K3 Grading System</title>
    
    <!-- Dynamic Favicons -->
    <link rel="icon" id="app-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <link rel="apple-touch-icon" id="app-apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: 'var(--c-50)',
                            100: 'var(--c-100)',
                            200: 'var(--c-200)',
                            300: 'var(--c-300)',
                            400: 'var(--c-400)',
                            500: 'var(--c-500)',
                            600: 'var(--c-600)',
                            700: 'var(--c-700)',
                            800: 'var(--c-800)',
                            900: 'var(--c-900)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Inter:wght@400;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3, .comic-font { font-family: 'Comic Neue', cursive; }
        
        /* CSS Variables for Themes - Default Indigo */
        :root {
            --c-50: #eef2ff; --c-100: #e0e7ff; --c-200: #c7d2fe; --c-300: #a5b4fc;
            --c-400: #818cf8; --c-500: #6366f1; --c-600: #4f46e5; --c-700: #4338ca;
            --c-800: #3730a3; --c-900: #312e81;
        }

        /* Essential Utilities */
        .hidden { display: none !important; }
        
        /* Print Styles */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-container { 
                width: 100%; 
                max-width: 100%;
                font-size: 12px; 
            }
            table { border-collapse: collapse; width: 100%; }
            th, td { border: 1px solid #cbd5e1 !important; page-break-inside: avoid; }
            #student-list-container { overflow: visible !important; }
            main { margin: 0; padding: 0; max-width: none; }
            
            /* Print friendly colors */
            .bg-emerald-100 { background-color: #dcfce7 !important; }
            .bg-red-50 { background-color: #fef2f2 !important; }
            
            /* Print Header Layout */
            .print-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #eee;
                padding-bottom: 10px;
            }
            .print-logo {
                height: 80px;
                width: auto;
                margin-bottom: 10px;
                object-fit: contain;
            }
        }

        .print-only { display: none; }
        .grade-input:focus { outline: none; border-color: var(--c-500); ring: 2px; ring-color: var(--c-200); }
        
        /* Theme Swatches */
        .theme-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 2px #e5e7eb; }
        .theme-swatch.active { box-shadow: 0 0 0 2px var(--c-600); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-primary-600 text-white shadow-lg sticky top-0 z-50 no-print transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <!-- Logo Display (Click to open settings) -->
                <div class="relative group cursor-pointer" onclick="window.openSettingsModal()" title="App Settings">
                    <div id="header-logo-container" class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center border-2 border-primary-400 overflow-hidden hover:border-white transition">
                        <svg id="default-logo-icon" class="w-6 h-6 text-primary-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <img id="header-logo-img" class="hidden w-full h-full object-cover" alt="School Logo">
                    </div>
                </div>
                
                <div>
                    <h1 class="text-2xl font-bold comic-font tracking-wide leading-none">Neerada School</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <p class="text-primary-200 text-xs">K3 Grading App ‚Ä¢ Cloud Sync</p>
                        
                        <!-- School Year Selector -->
                        <select id="school-year-select" class="bg-primary-700 text-white text-xs border border-primary-500 rounded px-2 py-0.5 focus:outline-none focus:ring-1 focus:ring-white">
                            <option value="SY 2025-2026">SY 2025-2026</option>
                            <option value="SY 2026-2027">SY 2026-2027</option>
                            <option value="SY 2027-2028">SY 2027-2028</option>
                            <option value="SY 2028-2029">SY 2028-2029</option>
                            <option value="SY 2029-2030">SY 2029-2030</option>
                            <option value="SY 2030-2031">SY 2030-2031</option>
                        </select>
                        
                        <!-- Auth Status Indicator -->
                        <div id="auth-status" class="w-2 h-2 rounded-full bg-red-400 animate-pulse ml-2" title="Connecting to Database..."></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 items-center">
                <!-- Settings Gear -->
                <button onclick="window.openSettingsModal()" class="p-2 text-primary-200 hover:text-white transition rounded-full hover:bg-primary-500" title="Settings & Themes">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>

                <button onclick="document.getElementById('restore-upload').click()" class="text-xs bg-orange-500 hover:bg-orange-600 px-3 py-1 rounded text-white transition flex items-center gap-1 shadow-sm border border-orange-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Restore
                </button>
                <button onclick="window.print()" class="text-xs bg-primary-500 hover:bg-primary-400 px-3 py-1 rounded text-white transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Print
                </button>
                <button onclick="window.exportData()" class="text-xs bg-primary-800 hover:bg-primary-900 px-3 py-1 rounded border border-primary-500 transition">
                    Backup
                </button>
            </div>
        </div>
        <input type="file" id="restore-upload" hidden accept=".json">
    </header>

    <!-- Print Header (Only visible when printing the main dashboard) -->
    <div id="main-print-header" class="print-only mb-6">
        <div class="print-header">
            <img id="print-view-logo" class="print-logo hidden" alt="School Logo">
            <h1 class="text-3xl font-bold text-center comic-font">Neerada School</h1>
            <h2 class="text-xl font-bold text-center mt-2 comic-font">Class Record: <span id="print-section-name"></span></h2>
            <p class="text-center text-slate-500 text-sm mt-1">English Subject ‚Ä¢ January to June ‚Ä¢ <span id="print-year-label"></span></p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-4 print-container">
        
        <!-- View Switcher -->
        <div id="section-selector" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 mb-6 no-print">
            <!-- Buttons injected by JS -->
            <div class="col-span-full text-center text-slate-400 text-sm py-4">Loading sections from cloud...</div>
        </div>

        <!-- Dashboard -->
        <div id="app-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[500px]">
            
            <!-- Toolbar -->
            <div class="p-4 border-b border-slate-100 flex flex-wrap justify-between items-center bg-slate-50/50 gap-4 no-print">
                <div class="flex items-center gap-2">
                    <h2 id="current-section-title" class="text-xl font-bold text-slate-700 comic-font">Loading...</h2>
                    <button onclick="window.editSectionName()" id="edit-section-btn" class="hidden text-slate-400 hover:text-primary-600 transition" title="Rename Section">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </div>
                
                <div id="action-buttons" class="hidden flex gap-2">
                    <!-- Reset Scores Button -->
                    <button onclick="window.resetAllScores()" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center gap-1" title="Reset all scores for this section and year to zero">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Reset All Scores
                    </button>
                    <!-- Import CSV Button -->
                    <button onclick="window.openImportModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Import CSV
                    </button>
                    <!-- Add Student Button -->
                    <button onclick="window.openAddStudentModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-sm transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add Student
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-slate-400 no-print">
                <p>Connecting to Firebase...</p>
            </div>

            <!-- Student List Table -->
            <div id="student-list-container" class="hidden overflow-x-auto pb-12">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-300">
                        <tr id="table-header-row">
                            <!-- Headers injected by JS -->
                        </tr>
                    </thead>
                    <tbody id="student-table-body" class="divide-y divide-slate-100">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-auto py-6 no-print">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm">
                &copy; <span id="copyright-year"></span> Neerada School. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Modal: Settings & Themes -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold comic-font text-slate-700">App Settings</h3>
                <button onclick="window.closeModal('settings-modal')" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Theme Selector -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Color Theme</label>
                <div class="flex gap-3 justify-center">
                    <div onclick="window.applyTheme('indigo')" class="theme-swatch bg-indigo-600" title="Indigo (Default)"></div>
                    <div onclick="window.applyTheme('rose')" class="theme-swatch bg-rose-600" title="Rose"></div>
                    <div onclick="window.applyTheme('emerald')" class="theme-swatch bg-emerald-600" title="Emerald"></div>
                    <div onclick="window.applyTheme('amber')" class="theme-swatch bg-amber-600" title="Amber"></div>
                    <div onclick="window.applyTheme('violet')" class="theme-swatch bg-violet-600" title="Violet"></div>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">School Logo</label>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center border overflow-hidden">
                        <img id="settings-logo-preview" class="w-full h-full object-contain hidden">
                        <span id="settings-logo-placeholder" class="text-xs text-slate-400">None</span>
                    </div>
                    <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded text-xs font-medium transition">
                        Upload Logo
                        <input type="file" hidden accept="image/*" onchange="window.handleLogoUpload(event)">
                    </label>
                </div>
            </div>

            <!-- Favicon Upload -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Browser Icon (Favicon)</label>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center border overflow-hidden">
                        <img id="settings-favicon-preview" class="w-full h-full object-cover hidden">
                        <span id="settings-favicon-placeholder" class="text-xs text-slate-400">Icon</span>
                    </div>
                    <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded text-xs font-medium transition">
                        Upload Icon
                        <input type="file" hidden accept="image/*" onchange="window.handleFaviconUpload(event)">
                    </label>
                </div>
                <p class="text-[10px] text-slate-400 mt-1">Updates browser tab & mobile home screen icon.</p>
            </div>

            <!-- Load Default Data -->
            <div class="pt-6 border-t border-slate-100">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Data Management</label>
                <button onclick="window.loadK3Data()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-2 rounded text-sm font-medium transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Load K3 Default Data
                </button>
                <p class="text-[10px] text-center text-slate-400 mt-1">This will add the K3 student list if missing.</p>
            </div>
        </div>
    </div>

    <!-- Modal: Add Student -->
    <div id="add-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4 comic-font">Add New Student</h3>
            <p class="text-xs text-slate-500 mb-4 bg-slate-100 p-2 rounded">Adding to: <span class="font-bold" id="add-modal-year-display"></span></p>
            <form id="add-student-form">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                <input type="text" id="student-name-input" required class="w-full p-3 rounded border border-slate-300 mb-4 focus:ring-2 ring-primary-500 outline-none" placeholder="e.g. Juan dela Cruz">
                
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nickname (Optional)</label>
                <input type="text" id="student-nickname-input" class="w-full p-3 rounded border border-slate-300 mb-6 focus:ring-2 ring-primary-500 outline-none" placeholder="e.g. Juany">

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="window.closeModal('add-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded font-medium shadow transition">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Student -->
    <div id="edit-student-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4 comic-font">Edit Student Details</h3>
            <form id="edit-student-form">
                <input type="hidden" id="edit-student-id">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                <input type="text" id="edit-student-name" required class="w-full p-3 rounded border border-slate-300 mb-4 focus:ring-2 ring-primary-500 outline-none">
                
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nickname (Optional)</label>
                <input type="text" id="edit-student-nickname" class="w-full p-3 rounded border border-slate-300 mb-6 focus:ring-2 ring-primary-500 outline-none">

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="window.closeModal('edit-student-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium shadow transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Import CSV -->
    <div id="import-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-2 comic-font">Import Students via CSV</h3>
            <p class="text-sm text-slate-500 mb-6">Importing to: <span class="font-bold text-primary-700" id="import-section-name"></span> (<span id="import-year-display" class="font-medium"></span>)</p>
            
            <div class="bg-slate-50 border border-slate-200 rounded p-4 mb-6">
                <p class="text-xs font-bold text-slate-700 mb-2 uppercase">CSV Format:</p>
                <p class="text-xs text-slate-600 mb-2">Column 1: Full Name<br>Column 2: Nickname</p>
                <button onclick="window.downloadTemplate()" class="text-xs text-primary-600 hover:text-primary-800 underline flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download Template
                </button>
            </div>

            <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 mb-6"/>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="window.closeModal('import-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Cancel</button>
                <button type="button" onclick="window.handleCSVUpload()" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded font-medium shadow transition">Import Now</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Section Name -->
    <div id="rename-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-2 comic-font">Rename Section</h3>
            <form id="rename-section-form">
                <input type="text" id="section-rename-input" required class="w-full p-3 rounded border border-slate-300 mb-4">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="window.closeModal('rename-modal')" class="px-3 py-1 text-slate-600">Cancel</button>
                    <button type="submit" class="px-4 py-1 bg-primary-600 text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Set Perfect Score -->
    <div id="max-score-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-1 comic-font" id="max-score-month-title">January</h3>
            <p class="text-xs text-slate-500 mb-4">Set Perfect Score for this month. Grades recalculate automatically.</p>
            <form id="set-max-score-form">
                <input type="number" id="max-score-input" required min="1" class="w-full p-3 text-center text-2xl font-mono rounded border border-slate-300 mb-4 focus:ring-2 ring-primary-500 outline-none">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="window.closeModal('max-score-modal')" class="px-3 py-1 text-slate-600">Cancel</button>
                    <button type="submit" class="px-4 py-1 bg-primary-600 text-white rounded">Set Score</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Input Student Score -->
    <div id="score-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-bold comic-font" id="score-student-name">Student</h3>
                    <p class="text-xs text-slate-500" id="score-month-label">January</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase">Perfect Score</div>
                    <div class="text-lg font-bold text-primary-600" id="score-perfect-display">20</div>
                </div>
            </div>

            <form id="save-score-form">
                <input type="hidden" id="score-student-id">
                <input type="hidden" id="score-month-key">
                
                <label class="block text-sm font-bold text-slate-700 mb-2">Raw Score</label>
                <input type="number" step="0.1" id="raw-score-input" class="w-full p-4 text-3xl font-mono text-center rounded border border-slate-300 focus:ring-2 focus:ring-primary-500 outline-none mb-6" placeholder="0" oninput="window.calculatePreview()">

                <div class="text-center mb-6">
                    <div class="text-xs text-slate-400 uppercase">Grade Preview</div>
                    <div id="grade-preview" class="text-4xl font-bold text-slate-300 comic-font">1.0</div>
                </div>

                <button type="submit" class="w-full py-3 bg-primary-600 hover:bg-primary-700 text-white rounded font-bold shadow transition">Save Grade</button>
            </form>
        </div>
    </div>

    <!-- Modal: Student Notes -->
    <div id="notes-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 h-[80vh] flex flex-col">
            <div class="mb-4">
                <h3 class="text-xl font-bold comic-font">Progress Notes</h3>
                <p class="text-sm text-slate-500">Reading & Writing Observations for <span id="notes-student-name" class="font-bold text-primary-600"></span></p>
            </div>
            
            <form id="save-notes-form" class="flex-grow flex flex-col overflow-hidden">
                <input type="hidden" id="notes-student-id">
                
                <div id="notes-list-container" class="flex-grow overflow-y-auto pr-2 mb-4 space-y-4">
                    <!-- Note fields injected by JS -->
                </div>

                <div class="flex justify-end gap-2 pt-4 border-t border-slate-100">
                    <button type="button" onclick="window.closeModal('notes-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded transition">Close</button>
                    <button type="submit" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded font-medium shadow transition">Save Notes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/70 z-[200] hidden flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <div class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin mb-4"></div>
        <p id="loading-message" class="text-lg font-bold comic-font tracking-wide">Processing...</p>
    </div>

    <!-- Printable Area (Hidden, populated dynamically when printing specific month) -->
    <div id="print-area" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, addDoc, deleteDoc, getDoc, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration & Initialization ---
        let firebaseConfig, appId;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                throw new Error("Local environment detected");
            }
        } catch (e) {
            firebaseConfig = {
                apiKey: "AIzaSyAVe3_P_rNkI7tvw3yPABvtAB6jI9y479A",
                authDomain: "neerada-grading.firebaseapp.com",
                projectId: "neerada-grading",
                storageBucket: "neerada-grading.firebasestorage.app",
                messagingSenderId: "375627658475",
                appId: "1:375627658475:web:fd28e650d6afc8fcbf3aae"
            };
            appId = 'neerada-grading-v1'; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Try enabling persistence for speed
        try {
            enableIndexedDbPersistence(db).catch(err => {
                if (err.code == 'failed-precondition') {
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code == 'unimplemented') {
                    console.log('Persistence not supported');
                }
            });
        } catch(e) {
            console.log("Persistence setup skipped");
        }

        let userId = null;
        
        // --- App Data ---
        // Compact version of user provided data
        const PRELOADED_DATA = {"sections":[{"id":"sec_1","name":"Langsat ‡∫•‡∫±‡∫á‚Äã‡∫™‡∫≤‡∫î","maxScores":{"jan":50}},{"id":"sec_2","name":"Longkong ‚Äã‡∫•‡∫≠‡∫á‡∫Å‡∫≠‡∫á","maxScores":{}},{"id":"sec_3","name":"‚ÄãTomato ‡ªÄ‡∫•‡∫±‡ªà‡∫ô","maxScores":{}},{"id":"sec_4","name":"‚ÄãGrapes ‡∫•‡∫≤‚Äã‡ªÅ‡∫ä‡ªã‡∫á","maxScores":{}},{"id":"sec_5","name":"‚ÄãLynchee ‡∫•‡∫¥‡∫ô‚Äã‡∫à‡∫µ‡ªà","maxScores":{}},{"id":"sec_6","name":"Lamut ‡∫•‡∫∞‚Äã‡∫°‡∫∏‡∫î","maxScores":{}},{"id":"sec_7","name":"‚ÄãLamyay ‡∫•‡∫≥‚Äã‡ªÉ‡∫ç","maxScores":{}}],"students":[{"id":"1766128854295wdydg","name":"Tanya Inthalangsy","nickname":"Tanya","sectionId":"sec_1"},{"id":"1766128854298p5k97","name":"Nanthida Souliyavong","nickname":"Anew","sectionId":"sec_1"},{"id":"17661288542998wnrl","name":"Thipphaphone Siphanith","nickname":"Bella","sectionId":"sec_1"},{"id":"17661288543003tlgn","name":"Aphatsala Nanthavong","nickname":"Nirin","sectionId":"sec_1"},{"id":"1766128854300ogpo2","name":"Peeyada Insixiengmai","nickname":"Namhom","sectionId":"sec_1"},{"id":"1766128854302ezr11","name":"Phetmany Osoulin","nickname":"Emmy","sectionId":"sec_1"},{"id":"1766128854302m4ovd","name":"Souknapha Kingvongsa","nickname":"Pangpang","sectionId":"sec_1"},{"id":"176612885430339q62","name":"Namthida Keobounla","nickname":"Aura","sectionId":"sec_1"},{"id":"1766128854303of8fa","name":"Phonemanee Lattana","nickname":"Beena","sectionId":"sec_1"},{"id":"1766128854303rt07j","name":"Kanyalat Lueanvilay","nickname":"Disney","sectionId":"sec_1"},{"id":"1766128854303ue17i","name":"Sounjangwei Sisongkham","nickname":"Jangwei","sectionId":"sec_1"},{"id":"17661288543045nw29","name":"Phantue Phommavichith","nickname":"Phantue","sectionId":"sec_1"},{"id":"1766128854304ym09o","name":"Thipphasone Basavanhthong","nickname":"Namthip","sectionId":"sec_1"},{"id":"1766128854304yq3ce","name":"Moukthida Singkhambua","nickname":"Aomsin","sectionId":"sec_1"},{"id":"1766128854304z8fxi","name":"Palamee Tanongkham","nickname":"Ben","sectionId":"sec_1"},{"id":"17661288543059n7hs","name":"Soukphakone Sysouphan","nickname":"Soukphakone","sectionId":"sec_1"},{"id":"1766128854305ayh8y","name":"Quangkhai Nguyennhu","nickname":"Navin","sectionId":"sec_1"},{"id":"1766128854305k6ccw","name":"Pounxayya Houngheuangmanh","nickname":"Lion","sectionId":"sec_1"},{"id":"1766128854305mgt8c","name":"Xaynakhone Vanhkham","nickname":"Phupha","sectionId":"sec_1"},{"id":"17661288543068kcwp","name":"Phisithxay Sanatem","nickname":"Potter","sectionId":"sec_1"},{"id":"1766128854306anwn7","name":"Sonsai Daeng Misai","nickname":"Fat","sectionId":"sec_1"},{"id":"1766128854306l1w27","name":"Ariyasack Rasaphon","nickname":"Thewise","sectionId":"sec_1"},{"id":"1766128854306wuete","name":"Phetsavanh Chalernsack","nickname":"Tutor","sectionId":"sec_1"},{"id":"17661288543079hv5a","name":"Sonexay Sichantha","nickname":"Phayu","sectionId":"sec_1"},{"id":"1766128854307cltaz","name":"Super Phonhalard","nickname":"Super","sectionId":"sec_1"},{"id":"1766128854307guut7","name":"Thavisouk Ounmano","nickname":"Mickey","sectionId":"sec_1"},{"id":"1768187691679yiumv","name":"Vannapha Sikounlabout","nickname":"Anya","sectionId":"sec_2"},{"id":"176818769168093cb5","name":"Silathip Chanthavong","nickname":"Celine","sectionId":"sec_2"},{"id":"1768187691680czvz3","name":"Minthila Phommanin","nickname":"Minnie","sectionId":"sec_2"},{"id":"1768187691680hotls","name":"Phonethida Bounheuang","nickname":"Panao","sectionId":"sec_2"},{"id":"1768187691681nlozr","name":"Nitdavorn Bouaphachan","nickname":"Nong Mai","sectionId":"sec_2"},{"id":"1768187691681vrq20","name":"Somvang Linavong","nickname":"Ai Ton","sectionId":"sec_2"},{"id":"1768187691682hxh7q","name":"Sornsakda Singhavong","nickname":"Yota","sectionId":"sec_2"},{"id":"1768187691682jk6n3","name":"Sanasone Davilayhong","nickname":"Anon","sectionId":"sec_2"},{"id":"17681876916834in95","name":"Nakhonexap Laoly","nickname":"Avin","sectionId":"sec_2"},{"id":"1768187691683as5m4","name":"Thavysouk Tommany","nickname":"Yai","sectionId":"sec_2"},{"id":"1768187691684cpttm","name":"Sokthavy Phongpachit","nickname":"Jame","sectionId":"sec_2"},{"id":"1768187691684g5nlu","name":"Alounyadeth Sayoudone","nickname":"Copter","sectionId":"sec_2"},{"id":"17681876916858ff5q","name":"Nilada Phithakvong","nickname":"Phamee","sectionId":"sec_2"},{"id":"17681876916859rtxb","name":"Douangdao Vongvilay","nickname":"Bao","sectionId":"sec_2"},{"id":"1768187691686p92hv","name":"Bounthidaly Xayyasaeng","nickname":"Bonus","sectionId":"sec_2"},{"id":"1768187691686qdr3f","name":"Khuansouda Chanthavong","nickname":"Mila","sectionId":"sec_2"},{"id":"176818769168761a11","name":"Valout Liaolaeng","nickname":"Nong Ka","sectionId":"sec_2"},{"id":"1768187691687c8csy","name":"Analin Saengkham","nickname":"Terra","sectionId":"sec_2"},{"id":"1768187691687cpqtu","name":"Anavin Kaeovanthien","nickname":"Amy","sectionId":"sec_2"},{"id":"1768187691688owodk","name":"Sitthisok Saeng-outhone","nickname":"Iron","sectionId":"sec_2"},{"id":"1768187691688xtc5i","name":"Nanthakone Phanthavy","nickname":"Owen","sectionId":"sec_2"},{"id":"17681876916895esde","name":"Phonphain Chula","nickname":"Bio","sectionId":"sec_2"},{"id":"1768187691689m9kuk","name":"Sitthidet Louangphakdy","nickname":"Kop","sectionId":"sec_2"},{"id":"1768187691689v1mnb","name":"Sornmeexay Vorasane","nickname":"Doka","sectionId":"sec_2"},{"id":"1768187691690g2xk2","name":"Phousavan Xayyapanya","nickname":"Topten","sectionId":"sec_2"},{"id":"1768187691690k2l5w","name":"Bounthasok Phanavan","nickname":"Boston","sectionId":"sec_2"},{"id":"1768188081499zxl92","name":"Netnaree Mingboupha","nickname":"Naree","sectionId":"sec_3"},{"id":"17681880815047p23f","name":"Kaeothida Phetchampa","nickname":"Moukda","sectionId":"sec_3"},{"id":"1768188081504k6c05","name":"Niphada Inthavong","nickname":"Noey Noey","sectionId":"sec_3"},{"id":"1768188081505bv5ek","name":"Soupharat Philavong","nickname":"Pram Pram","sectionId":"sec_3"},{"id":"1768188081505wneic","name":"Valinphone Chanthaminavong","nickname":"Maybe","sectionId":"sec_3"},{"id":"17681880815065rr4e","name":"Vatsana Louangphasy","nickname":"Youly","sectionId":"sec_3"},{"id":"1768188081506us0eu","name":"Vilada Sounthone","nickname":"June","sectionId":"sec_3"},{"id":"176818808150743r8r","name":"Vilayphet Phosalat","nickname":"Diwka","sectionId":"sec_3"},{"id":"1768188081507rxfzh","name":"Netnapha Ousakoun","nickname":"Ing Ing","sectionId":"sec_3"},{"id":"1768188081507z9moa","name":"Minnie Vilayphon","nickname":"Minnie","sectionId":"sec_3"},{"id":"1768188081508h7ijl","name":"Manida Manykham","nickname":"Ailin","sectionId":"sec_3"},{"id":"1768188081508nx3k7","name":"Soutthida Yakanaki","nickname":"Tina","sectionId":"sec_3"},{"id":"1768188081509bzdo9","name":"Phavana Kaeohavong","nickname":"Party","sectionId":"sec_3"},{"id":"1768188081509nzj65","name":"Maniphone Kaeovilyavong","nickname":"Pinky","sectionId":"sec_3"},{"id":"1768188081509or3s7","name":"Salongxay Phommixay","nickname":"Navin","sectionId":"sec_3"},{"id":"17681880815102rseo","name":"Khampasong Vongphakdy","nickname":"Winner","sectionId":"sec_3"},{"id":"1768188081510aeggo","name":"Thavyxap Viengkamsone","nickname":"Phoupha","sectionId":"sec_3"},{"id":"1768188081510bb49j","name":"Likhitxay Libouapao","nickname":"Likhit","sectionId":"sec_3"},{"id":"176818808151181z7y","name":"Alounyadeth Saenvong","nickname":"Nai","sectionId":"sec_3"},{"id":"176818808151189j8b","name":"Thanousone Louangsamat","nickname":"Micka","sectionId":"sec_3"},{"id":"1768188081511uz22a","name":"Soukmeexay Manyvanh","nickname":"Copter","sectionId":"sec_3"},{"id":"17681880815125w7n8","name":"Anouxsa Faengmany","nickname":"Dino","sectionId":"sec_3"},{"id":"1768188081512mtqid","name":"Phonethideth Khambouaxay","nickname":"Phasok","sectionId":"sec_3"},{"id":"1768188081512pxj4u","name":"Soukthavone Nolinntha","nickname":"Demo","sectionId":"sec_3"},{"id":"1768188081512rf3rp","name":"Thepphaxay Phoumvixay","nickname":"Q","sectionId":"sec_3"},{"id":"1768188473266q2z3g","name":"Phetthida Chaleunsouk","nickname":"Baby","sectionId":"sec_4"},{"id":"1768188473268y9qxz","name":"Chiraphone Khattiyalat","nickname":"Aida","sectionId":"sec_4"},{"id":"1768188473269bfptu","name":"Linrada Khounnuvong","nickname":"Yuri","sectionId":"sec_4"},{"id":"1768188473269l1zht","name":"Palita Xayaphim","nickname":"Meya","sectionId":"sec_4"},{"id":"1768188473270btf55","name":"Manylin Savongthong","nickname":"Nam","sectionId":"sec_4"},{"id":"1768188473270ohbnx","name":"Inthila Phommavanh","nickname":"Milin","sectionId":"sec_4"},{"id":"1768188473271nitg3","name":"Phetsakhone Kaethalong","nickname":"Aphing","sectionId":"sec_4"},{"id":"1768188473271qhvu9","name":"Phet-dala Louanglat","nickname":"Bella","sectionId":"sec_4"},{"id":"17681884732727qpj1","name":"Phimsoupha Latxavong","nickname":"Khaohom","sectionId":"sec_4"},{"id":"1768188473272a96wt","name":"Thidasavan Bounsane","nickname":"Thida","sectionId":"sec_4"},{"id":"1768188473272eccpd","name":"Phoutthida Saendy","nickname":"Nuey","sectionId":"sec_4"},{"id":"17681884732737lju0","name":"Namfon Chaichia","nickname":"Mimor","sectionId":"sec_4"},{"id":"1768188473273fml4e","name":"Fasai Vangxouapao","nickname":"Fasai","sectionId":"sec_4"},{"id":"1768188473273wgncf","name":"Kaolouxi Vangxayyear","nickname":"Lucy","sectionId":"sec_4"},{"id":"17681884732743empu","name":"Anouphap Souphanthone","nickname":"Jojo","sectionId":"sec_4"},{"id":"1768188473274vh8ri","name":"Soutthida Kaeosavang","nickname":"Peng","sectionId":"sec_4"},{"id":"1768188473274x6pqs","name":"Phourixay Louangkhot","nickname":"Mavin","sectionId":"sec_4"},{"id":"1768188473275c0npr","name":"Xayyavong Vilay","nickname":"Tiger","sectionId":"sec_4"},{"id":"1768188473275duxer","name":"Thepphakoun Homsombat","nickname":"Jaokhoun","sectionId":"sec_4"},{"id":"1768188473275z7e81","name":"Thanakhone Chittalath","nickname":"Athen","sectionId":"sec_4"},{"id":"1768188473275zo5yk","name":"Alanda Phanthavong","nickname":"Latte","sectionId":"sec_4"},{"id":"1768188473276bns1d","name":"Phisitxay Sitthidet","nickname":"Newtern","sectionId":"sec_4"},{"id":"1768188473276sj5ko","name":"Inthachak Mounthong","nickname":"Bank","sectionId":"sec_4"},{"id":"1768188473276ugetp","name":"Sokthavy Vongvichit","nickname":"Captain","sectionId":"sec_4"},{"id":"17681884732773ojgt","name":"Vilakone Vitthanakoun","nickname":"Anon","sectionId":"sec_4"},{"id":"17681884732774ryuj","name":"Sokthavy Xaypanya","nickname":"Cooper","sectionId":"sec_4"},{"id":"1768188473277msznp","name":"Bounman Sitsouvong","nickname":"Lion","sectionId":"sec_4"},{"id":"1768188473277tcpus","name":"Chitpanya Vongxay","nickname":"Vinda","sectionId":"sec_4"},{"id":"1768189676656vyirp","name":"Elsa Naphanthalak","nickname":"Elsa","sectionId":"sec_5"},{"id":"17681896766573puem","name":"Anita Thammyphone","nickname":"Anita","sectionId":"sec_5"},{"id":"1768189676657euwad","name":"Moukdalin Soinxay","nickname":"Moukda","sectionId":"sec_5"},{"id":"1768189676658d4fd1","name":"Moukthida Douangchaleun","nickname":"Thida","sectionId":"sec_5"},{"id":"1768189676658d4fd1","name":"Moukthida Douangchaleun","nickname":"Thida","sectionId":"sec_5"},{"id":"17681896766595pmm0","name":"Phetmixay Xayyavong","nickname":"Amuey","sectionId":"sec_5"},{"id":"1768189676659bs6op","name":"Alisa Vixay","nickname":"Aphing","sectionId":"sec_5"},{"id":"1768189676659voatx","name":"Viphavady Chittalath","nickname":"Minta","sectionId":"sec_5"},{"id":"1768189676660hc87l","name":"Solada Phommachack","nickname":"Fena","sectionId":"sec_5"},{"id":"1768189676660rffhf","name":"Chanthamaly Phothipanya","nickname":"Dalin","sectionId":"sec_5"},{"id":"1768189676661f2bjo","name":"Nouan-aksone Phommaly","nickname":"Ansan","sectionId":"sec_5"},{"id":"1768189676661p8nzg","name":"Phetdala Thongsavath","nickname":"Mango","sectionId":"sec_5"},{"id":"1768189676662fx6us","name":"Evarin Sommalavong","nickname":"Eva","sectionId":"sec_5"},{"id":"1768189676662sieyy","name":"Souphada Thammavong","nickname":"Yingmeuy","sectionId":"sec_5"},{"id":"1768189676663e67hv","name":"Phasit Sisouvanthong","nickname":"Magnum","sectionId":"sec_5"},{"id":"1768189676663hcrql","name":"Vanxanaxay Phimmasane","nickname":"Navin","sectionId":"sec_5"},{"id":"1768189676663unoh5","name":"Bounxay Saengdavan","nickname":"Ashi","sectionId":"sec_5"},{"id":"17681896766648e955","name":"Souphakone Phommachanh","nickname":"Garfield","sectionId":"sec_5"},{"id":"1768189676664xnfv6","name":"Santisok Saengchaleun","nickname":"Tonka","sectionId":"sec_5"},{"id":"1768189676665dskvf","name":"Xay-inthasone Vixay","nickname":"Xainoy","sectionId":"sec_5"},{"id":"1768189676665k32y7","name":"Yichan Boliboun","nickname":"Yisan","sectionId":"sec_5"},{"id":"1768189676665l3dbh","name":"Thanyasone Tounalom","nickname":"Fluke","sectionId":"sec_5"},{"id":"1768189676666bpkic","name":"Santi Dalasaen","nickname":"Newtern","sectionId":"sec_5"},{"id":"1768189676666ly56n","name":"Toula Xayyahan","nickname":"Peter","sectionId":"sec_5"},{"id":"1768189676666zabew","name":"Soutpaseut Khiaovongphachan","nickname":"Newton","sectionId":"sec_5"},{"id":"17681900686048ea9b","name":"Chansoupha Phanthavong","nickname":"Bowie","sectionId":"sec_6"},{"id":"1768190068605gyd7d","name":"Phimfasai Thongsavath","nickname":"Lisa","sectionId":"sec_6"},{"id":"1768190068605mnon6","name":"Alina Soukchanthala","nickname":"Candy","sectionId":"sec_6"},{"id":"17681900686061jlwt","name":"Navita Boothnate","nickname":"Nita","sectionId":"sec_6"},{"id":"176819006860650b0k","name":"Navida Boothnate","nickname":"Nida","sectionId":"sec_6"},{"id":"1768190068606u3qdq","name":"Namneung Daokhammouan","nickname":"Namneung","sectionId":"sec_6"},{"id":"17681900686077wo0l","name":"Vonvilay Meemounphon","nickname":"Toukta","sectionId":"sec_6"},{"id":"1768190068607bdzko","name":"Fathida Nanthalangsy","nickname":"Fanoy","sectionId":"sec_6"},{"id":"1768190068607euzpn","name":"Valannya Vongkhamsouk","nickname":"Valin","sectionId":"sec_6"},{"id":"1768190068608hise8","name":"Souphansa Vorabout","nickname":"Baby","sectionId":"sec_6"},{"id":"1768190068608krddv","name":"Phonethanakit Inthavong","nickname":"Phon","sectionId":"sec_6"},{"id":"1768190068608y4tkx","name":"Lattanamany Louanglat","nickname":"Stamp","sectionId":"sec_6"},{"id":"17681900686093r80b","name":"Adilat Sourinsak","nickname":"Kina","sectionId":"sec_6"},{"id":"1768190068609ja631","name":"Souliyadet Khounboulom","nickname":"Star","sectionId":"sec_6"},{"id":"1768190068609tridi","name":"Oudomxap Chaleunsouk","nickname":"Brooklyn","sectionId":"sec_6"},{"id":"1768190068610f4ask","name":"Phongxap Chandinavong","nickname":"Copter","sectionId":"sec_6"},{"id":"1768190068610qu3rt","name":"Noah Songbriayi","nickname":"Noah","sectionId":"sec_6"},{"id":"1768190068610ydkx1","name":"Xettha Phetthavisaeng","nickname":"Lemon","sectionId":"sec_6"},{"id":"176819006861131we3","name":"Thanakhone Louangaphai","nickname":"Winner","sectionId":"sec_6"},{"id":"1768190068611e4mj8","name":"Viengphone Sidala","nickname":"Euro","sectionId":"sec_6"},{"id":"1768190068611nqj85","name":"Phetsakda Souliya","nickname":"Thala","sectionId":"sec_6"},{"id":"1768190068611oeoak","name":"Sirikone Kaeodouangdy","nickname":"Eric","sectionId":"sec_6"},{"id":"17681900686120mwdu","name":"Detasa Somchanmavong","nickname":"Oneil","sectionId":"sec_6"},{"id":"1768190068612pt0pg","name":"Soukpasong Phansamay","nickname":"Audi","sectionId":"sec_6"},{"id":"1768190068612wt7w2","name":"Thavyxok Vorachakdaovy","nickname":"Bronte","sectionId":"sec_6"},{"id":"1768190068613abi69","name":"Phonepaseuth Phoutthavong","nickname":"Alex","sectionId":"sec_6"},{"id":"1768190612438oon2t","name":"Thipdavanh Souksala","nickname":"Tamon","sectionId":"sec_7"},{"id":"17681906124390d70v","name":"Nalisa Chanthalasy","nickname":"Malin","sectionId":"sec_7"},{"id":"1768190612440fmihl","name":"Phetsavan Latxavong","nickname":"Vanmai","sectionId":"sec_7"},{"id":"1768190612440il2fd","name":"Panisa Chitkhanti","nickname":"June","sectionId":"sec_7"},{"id":"17681906124412mgmf","name":"Panisa Sisombat","nickname":"Lisa","sectionId":"sec_7"},{"id":"17681906124418q4g9","name":"Piyamone Sichanthavong","nickname":"Mindy","sectionId":"sec_7"},{"id":"1768190612441cj3vq","name":"Palamy Phimmaxak","nickname":"Thapthim","sectionId":"sec_7"},{"id":"1768190612442limbt","name":"Minaphone Saeng-amphon","nickname":"Tataem","sectionId":"sec_7"},{"id":"1768190612442wxvup","name":"Phet-oulay Vilay","nickname":"Ngoc","sectionId":"sec_7"},{"id":"17681906124430a60a","name":"Manisa Chansina","nickname":"Maynie","sectionId":"sec_7"},{"id":"1768190612443e1rj0","name":"Sawoeysouk Xaybounliang","nickname":"Demi","sectionId":"sec_7"},{"id":"1768190612443t1v1i","name":"Phoutthida Panyanouvong","nickname":"Netty","sectionId":"sec_7"},{"id":"176819061244404vhe","name":"Naphavilay Hongvilay","nickname":"Baby","sectionId":"sec_7"},{"id":"1768190612444itkqe","name":"Phoudit Chitkhanti","nickname":"Jett","sectionId":"sec_7"},{"id":"1768190612445j7hup","name":"Koko Champa","nickname":"Coco","sectionId":"sec_7"},{"id":"1768190612445l680d","name":"Hatsady Soukhavong","nickname":"Danny","sectionId":"sec_7"},{"id":"1768190612446950xf","name":"Khamchanphichit Manikham","nickname":"Biw","sectionId":"sec_7"},{"id":"1768190612446dpbou","name":"Phoukhaoka Phanthavong","nickname":"Captan","sectionId":"sec_7"},{"id":"1768190612446vteif","name":"Ekkaphon Khounphilavan","nickname":"Man","sectionId":"sec_7"},{"id":"17681906124479r3pj","name":"Souphasone Dalaphet","nickname":"Khamaiy","sectionId":"sec_7"},{"id":"1768190612447csc1r","name":"Phakin Saengsay","nickname":"Jaozaiy","sectionId":"sec_7"},{"id":"1768190612447jmy56","name":"Visanou Boutsamay","nickname":"Viwill","sectionId":"sec_7"},{"id":"1768190612447k2zvs","name":"Thavyxap Phoumyvong","nickname":"Benly","sectionId":"sec_7"},{"id":"17681906124488a2vi","name":"Thavisouk Ounmano","nickname":"Mickey","sectionId":"sec_7"},{"id":"1768190612448c7g34","name":"Vilasone Phommany","nickname":"Bruno","sectionId":"sec_7"},{"id":"1768190612448j7vi9","name":"Xaynakhone Phimmasane","nickname":"Nai","sectionId":"sec_7"}]};

        const MONTHS = [
            { key: 'jan', label: 'January' },
            { key: 'feb', label: 'February' },
            { key: 'mar', label: 'March' },
            { key: 'apr', label: 'April' },
            { key: 'may', label: 'May' },
            { key: 'jun', label: 'June' }
        ];

        let currentSectionId = null;
        let currentSectionData = null;
        let currentMonthForMax = null;
        let currentSchoolYear = 'SY 2025-2026';
        let cachedLogo = null;
        
        // --- Helper: Get Collection Paths ---
        const getUserPath = (colName) => `artifacts/${appId}/users/${userId}/${colName}`;

        // --- Helper: Loading Indicator ---
        const showLoading = (msg = "Processing...") => {
            document.getElementById('loading-message').textContent = msg;
            document.getElementById('loading-overlay').classList.remove('hidden');
        };
        const hideLoading = () => {
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        // --- Auth & Init ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        const initApp = () => {
            initAuth();
            onAuthStateChanged(auth, handleUser);
        };

        const handleUser = async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('auth-status').classList.remove('bg-red-400', 'animate-pulse');
                document.getElementById('auth-status').classList.add('bg-emerald-400');
                document.getElementById('auth-status').title = "Connected to Firebase";
                
                // Optimization: Run independent fetches in parallel
                const [sections, settingsVoid, logoVoid] = await Promise.all([
                    getAllSections(),
                    loadSettings(),
                    loadLogo()
                ]);

                // Data Integrity Check using the already fetched sections
                if (sections.length === 0) {
                    console.log("No data found. Seeding...");
                    await window.loadK3Data(true);
                    return;
                }

                await renderSectionTabs(sections);
                document.getElementById('copyright-year').textContent = new Date().getFullYear();

                if (sections.length > 0) {
                    selectSection(sections[0].id);
                } else {
                    document.getElementById('empty-state').innerHTML = `<p class="text-slate-400">No sections found.</p>`;
                }
            }
        };

        // --- Helper: Batch Commit ---
        const batchCommit = async (items, path, idKey = 'id') => {
            const chunkSize = 400; // Safe limit under 500
            for (let i = 0; i < items.length; i += chunkSize) {
                const chunk = items.slice(i, i + chunkSize);
                const batch = writeBatch(db);
                chunk.forEach(item => {
                    // Use item ID or create new ref if ID missing
                    const docId = item[idKey] || doc(collection(db, path)).id;
                    const ref = doc(db, path, docId);
                    batch.set(ref, item, { merge: true });
                });
                await batch.commit();
            }
        };

        // --- Settings & Themes Logic ---

        const THEMES = {
            indigo: { 50:'#eef2ff', 100:'#e0e7ff', 200:'#c7d2fe', 300:'#a5b4fc', 400:'#818cf8', 500:'#6366f1', 600:'#4f46e5', 700:'#4338ca', 800:'#3730a3', 900:'#312e81' },
            rose:   { 50:'#fff1f2', 100:'#ffe4e6', 200:'#fecdd3', 300:'#fda4af', 400:'#fb7185', 500:'#f43f5e', 600:'#e11d48', 700:'#be123c', 800:'#9f1239', 900:'#881337' },
            emerald:{ 50:'#ecfdf5', 100:'#d1fae5', 200:'#a7f3d0', 300:'#6ee7b7', 400:'#34d399', 500:'#10b981', 600:'#059669', 700:'#047857', 800:'#065f46', 900:'#064e3b' },
            amber:  { 50:'#fffbeb', 100:'#fef3c7', 200:'#fde68a', 300:'#fcd34d', 400:'#fbbf24', 500:'#f59e0b', 600:'#d97706', 700:'#b45309', 800:'#92400e', 900:'#78350f' },
            violet: { 50:'#f5f3ff', 100:'#ede9fe', 200:'#ddd6fe', 300:'#c4b5fd', 400:'#a78bfa', 500:'#8b5cf6', 600:'#7c3aed', 700:'#6d28d9', 800:'#5b21b6', 900:'#4c1d95' }
        };

        window.openSettingsModal = () => document.getElementById('settings-modal').classList.remove('hidden');

        window.applyTheme = async (themeName) => {
            const colors = THEMES[themeName] || THEMES['indigo'];
            const root = document.documentElement;
            
            // Apply variables
            for (const [shade, value] of Object.entries(colors)) {
                root.style.setProperty(`--c-${shade}`, value);
            }

            // UI feedback
            document.querySelectorAll('.theme-swatch').forEach(el => el.classList.remove('active'));
            const activeSwatch = document.querySelector(`.theme-swatch[title*="${themeName.charAt(0).toUpperCase() + themeName.slice(1)}"]`);
            if(activeSwatch) activeSwatch.classList.add('active');

            // Save to DB
            if (userId) {
                await setDoc(doc(db, getUserPath('settings'), 'theme'), { name: themeName }, { merge: true });
            }
        };

        window.handleFaviconUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 200 * 1024) { alert("File too large. Max 200KB."); return; } // Small limit for icons

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                // Update DOM
                updateFaviconDOM(base64);
                // Save DB
                if (userId) {
                    await setDoc(doc(db, getUserPath('settings'), 'favicon'), { data: base64 }, { merge: true });
                    alert("Favicon saved!");
                }
            };
            reader.readAsDataURL(file);
        };

        const updateFaviconDOM = (base64) => {
            document.getElementById('app-favicon').href = base64;
            document.getElementById('app-apple-touch-icon').href = base64;
            
            const preview = document.getElementById('settings-favicon-preview');
            preview.src = base64;
            preview.classList.remove('hidden');
            document.getElementById('settings-favicon-placeholder').classList.add('hidden');
        };

        // --- Data Integrity & Access ---

        const ensureDataIntegrity = async () => {
            if (!userId) return;
            const sections = await getAllSections();
            if (sections.length === 0) {
                console.log("No data found. Seeding PRELOADED_DATA...");
                await window.loadK3Data(true); // silent load
                return true;
            }
            return false;
        };

        window.loadK3Data = async (silent = false) => {
            if (!userId) return;
            if (!silent && !confirm("Load K3 Default Data? This will overwrite existing data matching IDs.")) return;

            showLoading("Seeding Data...");
            try {
                // 1. Sections - Batch Write
                await batchCommit(PRELOADED_DATA.sections, getUserPath('sections'));

                // 2. Students - Prepare & Batch Write
                const studentsToSave = PRELOADED_DATA.students.map(s => ({
                    ...s,
                    schoolYear: s.schoolYear || 'SY 2025-2026',
                    scores: s.scores || {}
                }));
                await batchCommit(studentsToSave, getUserPath('students'));

                if (!silent) {
                    hideLoading();
                    alert(`Loaded ${studentsToSave.length} students successfully.`);
                    location.reload();
                } else {
                    hideLoading();
                    if(studentsToSave.length > 0) location.reload();
                }
            } catch (err) {
                hideLoading();
                console.error("Seeding error", err);
                if (!silent) alert("Error loading data. Check console.");
            }
        };
        
        const getAllSections = async () => {
            if (!userId) return [];
            const snapshot = await getDocs(collection(db, getUserPath('sections')));
            const sections = [];
            snapshot.forEach(doc => sections.push(doc.data()));
            // Sort by ID to keep order roughly consistent if IDs are predictable
            return sections.sort((a,b) => a.id.localeCompare(b.id));
        };

        const getSectionData = async (id) => {
            if (!userId) return null;
            const docSnap = await getDoc(doc(db, getUserPath('sections'), id));
            return docSnap.exists() ? docSnap.data() : null;
        };

        const updateSectionData = async (data) => {
            if (!userId) return;
            // Explicit merge to be safe
            await setDoc(doc(db, getUserPath('sections'), data.id), data, { merge: true });
        };

        const getStudents = async (sectionId) => {
            if (!userId) return [];
            const snapshot = await getDocs(collection(db, getUserPath('students')));
            const allStudents = [];
            snapshot.forEach(doc => {
                const s = doc.data();
                s.id = doc.id; // Ensure ID is attached
                allStudents.push(s);
            });
            // Client-side filtering as per Rule 2 (No complex queries)
            const filtered = allStudents.filter(s => 
                s.sectionId === sectionId && 
                (s.schoolYear || 'SY 2025-2026') === currentSchoolYear
            );
            return filtered.sort((a, b) => (a.nickname || a.name).localeCompare(b.nickname || b.name));
        };

        const addStudent = async (name, nickname, sectionId) => {
            if (!userId) return;
            const studentData = {
                name,
                nickname: nickname || '',
                sectionId,
                schoolYear: currentSchoolYear,
                scores: {},
                notes: {}
            };
            await addDoc(collection(db, getUserPath('students')), studentData);
        };

        const updateStudent = async (id, name, nickname) => {
            if (!userId) return;
            const ref = doc(db, getUserPath('students'), id);
            // Use setDoc with merge to avoid overwriting scores if we just have partial data
            await setDoc(ref, { name, nickname }, { merge: true });
        };

        const updateStudentScore = async (studentId, monthKey, raw) => {
            if (!userId) { alert("Not connected!"); return; }
            const ref = doc(db, getUserPath('students'), studentId);
            const val = parseFloat(raw);
            
            // Visual Feedback
            const btn = document.querySelector('#save-score-form button');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";
            btn.disabled = true;

            try {
                // Use dot notation for precise update of the specific score field
                const updatePayload = {};
                updatePayload[`scores.${monthKey}`] = val;
                
                // Try updateDoc first (safer for existing docs)
                try {
                    await updateDoc(ref, updatePayload);
                } catch (updateErr) {
                    // Fallback if document structure is missing scores map
                    await setDoc(ref, { scores: { [monthKey]: val } }, { merge: true });
                }
                
                document.getElementById('score-modal').classList.add('hidden');
                loadDashboard(currentSectionId); 
            } catch(e) {
                console.error("Save score error", e);
                alert("Failed to save score: " + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        const updateStudentNotes = async (studentId, notes) => {
            if (!userId) return;
            const ref = doc(db, getUserPath('students'), studentId);
            // Recursive merge for notes as well
            await setDoc(ref, { notes: notes }, { merge: true });
        };

        const deleteStudent = async (id) => {
            if(!confirm("Delete this student?")) return;
            if (!userId) return;
            await deleteDoc(doc(db, getUserPath('students'), id));
            loadDashboard(currentSectionId);
        };

        const resetAllScores = async () => {
            if(!confirm(`Are you sure you want to reset ALL scores to default (zero) for ${currentSectionData.name} in ${currentSchoolYear}? This cannot be undone.`)) return;
            if (!userId) return;
            
            showLoading("Resetting scores...");
            const students = await getStudents(currentSectionId);
            const items = students.map(s => ({ id: s.id, scores: {} }));
            await batchCommit(items, getUserPath('students'));
            
            hideLoading();
            alert(`Reset complete. ${students.length} students updated.`);
            loadDashboard(currentSectionId);
        };

        // --- Logo Logic ---

        window.handleLogoUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // Check size (Firestore limit 1MB). Warn if > 700KB to be safe with base64 overhead
            if (file.size > 700 * 1024) {
                alert("File too large. Please use a logo smaller than 700KB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                if (userId) {
                    await setDoc(doc(db, getUserPath('settings'), 'school_logo'), { data: base64 }, { merge: true });
                    displayLogo(base64);
                    alert("Logo saved successfully!");
                } else {
                    alert("Not connected to DB. Cannot save logo.");
                }
            };
            reader.readAsDataURL(file);
        };

        const loadLogo = async () => {
            if (!userId) return;
            try {
                const docSnap = await getDoc(doc(db, getUserPath('settings'), 'school_logo'));
                if (docSnap.exists()) {
                    displayLogo(docSnap.data().data);
                }
            } catch(e) {
                console.log("No logo found or load error", e);
            }
        };

        const displayLogo = (base64) => {
            cachedLogo = base64;
            document.getElementById('default-logo-icon').classList.add('hidden');
            const img = document.getElementById('header-logo-img');
            img.src = base64;
            img.classList.remove('hidden');
            const printImg = document.getElementById('print-view-logo');
            printImg.src = base64;
            printImg.classList.remove('hidden');
            
            // Settings Preview
            const setPreview = document.getElementById('settings-logo-preview');
            setPreview.src = base64;
            setPreview.classList.remove('hidden');
            document.getElementById('settings-logo-placeholder').classList.add('hidden');
        };

        // --- School Year & Settings Loader ---
        
        const loadSettings = async () => {
            if (!userId) return;
            const path = getUserPath('settings');
            
            // Parallel Fetch settings
            const [yearSnap, themeSnap, favSnap] = await Promise.all([
                getDoc(doc(db, path, 'selected_year')),
                getDoc(doc(db, path, 'theme')),
                getDoc(doc(db, path, 'favicon'))
            ]);

            if (yearSnap.exists()) {
                currentSchoolYear = yearSnap.data().val;
                document.getElementById('school-year-select').value = currentSchoolYear;
            }
            document.getElementById('print-year-label').textContent = currentSchoolYear;

            if (themeSnap.exists()) {
                window.applyTheme(themeSnap.data().name);
            } else {
                window.applyTheme('indigo'); 
            }

            if (favSnap.exists()) {
                updateFaviconDOM(favSnap.data().data);
            }
        };

        const changeSchoolYear = async () => {
            if (!userId) return;
            const newVal = document.getElementById('school-year-select').value;
            currentSchoolYear = newVal;
            
            await setDoc(doc(db, getUserPath('settings'), 'selected_year'), { val: newVal });
            
            document.getElementById('print-year-label').textContent = currentSchoolYear;
            
            if (currentSectionId) loadDashboard(currentSectionId);
        };

        // --- UI Logic ---
        
        const renderSectionTabs = async (sections) => {
            const container = document.getElementById('section-selector');
            if (sections.length === 0) {
                 container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-4">No sections available.</div>`;
                 return;
            }
            container.innerHTML = sections.map(sec => `
                <button onclick="window.selectSection('${sec.id}')"
                    class="py-3 px-2 rounded-lg text-sm font-semibold transition border border-slate-200 shadow-sm truncate
                    ${currentSectionId === sec.id ? 'bg-primary-600 text-white ring-2 ring-primary-300' : 'bg-white text-slate-600 hover:bg-slate-50'}">
                    ${sec.name}
                </button>
            `).join('');
        };

        const selectSection = async (id) => {
            currentSectionId = id;
            currentSectionData = await getSectionData(id);
            
            document.getElementById('current-section-title').textContent = currentSectionData.name;
            document.getElementById('print-section-name').textContent = currentSectionData.name;
            
            const importSection = document.getElementById('import-section-name');
            const importYear = document.getElementById('import-year-display');
            if (importSection) importSection.textContent = currentSectionData.name;
            
            document.getElementById('edit-section-btn').classList.remove('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('flex');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('student-list-container').classList.remove('hidden');
            
            const sections = await getAllSections();
            renderSectionTabs(sections);
            
            loadDashboard(id);
        };

        const loadDashboard = async (sectionId) => {
            const students = await getStudents(sectionId);
            const headerRow = document.getElementById('table-header-row');
            const tbody = document.getElementById('student-table-body');

            const monthColors = [
                'bg-rose-100 text-rose-900 border-rose-200',
                'bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200',
                'bg-violet-100 text-violet-900 border-violet-200',
                'bg-blue-100 text-blue-900 border-blue-200',
                'bg-cyan-100 text-cyan-900 border-cyan-200',
                'bg-emerald-100 text-emerald-900 border-emerald-200'
            ];

            // 1. Build Header
            let headersHTML = `<th class="p-4 w-12 bg-slate-200 border-b border-slate-300">#</th>
                               <th class="p-4 min-w-[180px] bg-orange-100 text-orange-900 border-b border-orange-200">Student Name</th>
                               <th class="p-4 min-w-[120px] bg-amber-100 text-amber-900 border-b border-amber-200">Nickname</th>`;
            
            MONTHS.forEach((m, i) => {
                const maxKey = `${currentSchoolYear}_${m.key}`;
                const max = currentSectionData.maxScores[maxKey] || 0;
                const maxDisplay = max > 0 ? `<span class="font-bold text-current">${max}</span>` : `<span class="text-red-500 opacity-70">Set Max</span>`;
                const colorClass = monthColors[i];

                headersHTML += `
                    <th class="p-2 text-center border-x min-w-[100px] group relative ${colorClass}">
                        <div class="flex flex-col items-center gap-1">
                            <span class="text-xs uppercase tracking-wider font-bold opacity-80">${m.label.substr(0,3)}</span>
                            <div class="flex gap-1 items-center">
                                <button onclick="window.openMaxScoreModal('${m.key}')" class="text-xs border border-white/50 bg-white/40 hover:bg-white/60 px-1 py-0.5 rounded transition min-w-[30px]">
                                    / ${maxDisplay}
                                </button>
                            </div>
                            <button onclick="window.printMonthReport('${m.key}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 hover:text-white transition no-print" title="Print ${m.label} Report">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                            </button>
                        </div>
                    </th>
                `;
            });
            headerRow.innerHTML = headersHTML + `<th class="p-4 text-right bg-slate-200 border-b border-slate-300 no-print">Actions</th>`;

            // 2. Build Rows
            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-slate-400 italic">No students found for ${currentSchoolYear}.</td></tr>`;
                return;
            }

            tbody.innerHTML = students.map((s, idx) => {
                let rowHTML = `<td class="p-3 text-slate-400 font-mono text-xs border-r border-slate-100 align-middle">${idx + 1}</td>
                               <td class="p-3 font-medium text-slate-700 border-r border-slate-100 align-middle">
                                    ${s.name}
                               </td>
                               <td class="p-3 text-slate-500 border-r border-slate-100 align-middle">
                                    <div class="flex items-center justify-between gap-2">
                                        <span>${s.nickname || '-'}</span>
                                        <button onclick="window.openNotesModal('${s.id}', '${s.name.replace(/'/g, "\\'")}')" class="text-slate-300 hover:text-primary-500 transition p-1 rounded hover:bg-primary-50 no-print" title="Progress Notes">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                        </button>
                                    </div>
                               </td>`;
                
                MONTHS.forEach(m => {
                    const maxKey = `${currentSchoolYear}_${m.key}`;
                    const raw = s.scores && s.scores[m.key];
                    const max = currentSectionData.maxScores[maxKey] || 0;
                    
                    let cellContent = '-';
                    let cellClass = 'bg-slate-50 text-slate-300';
                    let gradeVal = 0;

                    if (max > 0 && raw !== undefined && raw !== null) {
                        gradeVal = 1 + ((raw / max) * 9);
                        if(gradeVal > 10) gradeVal = 10;
                        if(gradeVal < 1) gradeVal = 1;
                        
                        const gradeFormatted = gradeVal.toFixed(1);
                        
                        cellContent = `<div class="flex flex-col leading-tight">
                                            <span class="font-bold text-lg">${gradeFormatted}</span>
                                            <span class="text-[10px] opacity-70">(${raw}/${max})</span>
                                           </div>`;

                        if (gradeVal >= 9) cellClass = 'bg-emerald-100 text-emerald-800 border-emerald-200';
                        else if (gradeVal >= 7.5) cellClass = 'bg-blue-50 text-blue-800 border-blue-200';
                        else if (gradeVal >= 5) cellClass = 'bg-yellow-50 text-yellow-800 border-yellow-200';
                        else cellClass = 'bg-red-50 text-red-800 border-red-200';
                    } else if (raw !== undefined) {
                        cellContent = `<span class="text-xs text-orange-500">Set Max!</span>`;
                    }

                    rowHTML += `
                        <td class="p-1 border-r border-slate-100 text-center align-middle">
                            <button onclick="window.openScoreModal('${s.id}', '${m.key}', '${s.name}')" 
                                class="w-full h-12 rounded flex items-center justify-center transition hover:shadow-md border ${cellClass}">
                                ${cellContent}
                            </button>
                        </td>
                    `;
                });

                rowHTML += `
                    <td class="p-3 text-right no-print align-middle">
                        <div class="flex justify-end gap-1">
                            <button onclick="window.openEditStudentModal('${s.id}', '${s.name}', '${s.nickname || ''}')" class="p-1 text-slate-400 hover:text-blue-500 transition" title="Edit Student">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="window.deleteStudent('${s.id}')" class="p-1 text-slate-400 hover:text-red-500 transition" title="Delete Student">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a2 2 0 00-1-1h-4a2 2 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </td>`;
                
                return `<tr class="hover:bg-slate-50 border-b border-slate-100">${rowHTML}</tr>`;
            }).join('');
        };

        // --- Global Handlers (Exposed to window for HTML click handlers) ---
        
        window.changeSchoolYear = () => changeSchoolYear();
        window.handleRestore = (e) => handleRestore(e);
        window.selectSection = (id) => selectSection(id);
        
        window.editSectionName = () => {
            document.getElementById('section-rename-input').value = currentSectionData.name;
            document.getElementById('rename-modal').classList.remove('hidden');
        };
        document.getElementById('rename-section-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = document.getElementById('section-rename-input').value.trim();
            if (newName) {
                currentSectionData.name = newName;
                await updateSectionData(currentSectionData);
                document.getElementById('rename-modal').classList.add('hidden');
                document.getElementById('current-section-title').textContent = newName;
                document.getElementById('print-section-name').textContent = newName;
                const importSection = document.getElementById('import-section-name');
                if (importSection) importSection.textContent = newName;
                const sections = await getAllSections();
                renderSectionTabs(sections);
            }
        });

        window.resetAllScores = () => resetAllScores();
        
        window.openImportModal = () => {
            const sectionNameSpan = document.getElementById('import-section-name');
            const yearSpan = document.getElementById('import-year-display');
            if (sectionNameSpan && currentSectionData) sectionNameSpan.textContent = currentSectionData.name;
            if (yearSpan) yearSpan.textContent = currentSchoolYear;
            document.getElementById('import-modal').classList.remove('hidden');
        };
        window.downloadTemplate = () => {
            const csvContent = "data:text/csv;charset=utf-8,Full Name,Nickname\nJohn Doe,Johnny\nMaria Clara,Mia";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        window.handleCSVUpload = async () => {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            if (!file) { alert("Please select a file first."); return; }
            if (!userId) { alert("Not connected to database."); return; }

            const reader = new FileReader();
            reader.onload = async function(e) {
                showLoading("Uploading CSV...");
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                let startIndex = 0;
                if(lines[0].toLowerCase().includes('name')) startIndex = 1;
                
                const studentsToAdd = [];
                for(let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if(line) {
                        const parts = line.split(',');
                        const name = parts[0] ? parts[0].trim() : '';
                        const nickname = parts[1] ? parts[1].trim() : '';
                        if(name) {
                            studentsToAdd.push({
                                name,
                                nickname: nickname || '',
                                sectionId: currentSectionId,
                                schoolYear: currentSchoolYear,
                                scores: {},
                                notes: {}
                            });
                        }
                    }
                }

                if (studentsToAdd.length > 0) {
                    await batchCommit(studentsToAdd, getUserPath('students'));
                    hideLoading();
                    alert(`Successfully imported ${studentsToAdd.length} students to ${currentSchoolYear}!`);
                    document.getElementById('import-modal').classList.add('hidden');
                    fileInput.value = ''; 
                    loadDashboard(currentSectionId);
                } else {
                    hideLoading();
                    alert("No valid students found in CSV.");
                }
            };
            reader.readAsText(file);
        };

        window.openAddStudentModal = () => {
            document.getElementById('add-modal-year-display').textContent = currentSchoolYear;
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('student-name-input').value = '';
            document.getElementById('student-nickname-input').value = '';
            setTimeout(() => document.getElementById('student-name-input').focus(), 100);
        };
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('student-name-input').value.trim();
            const nick = document.getElementById('student-nickname-input').value.trim();
            if (name) {
                await addStudent(name, nick, currentSectionId);
                document.getElementById('add-modal').classList.add('hidden');
                loadDashboard(currentSectionId);
            }
        });

        window.openMaxScoreModal = (monthKey) => {
            currentMonthForMax = monthKey;
            const maxKey = `${currentSchoolYear}_${monthKey}`;
            const currentMax = currentSectionData.maxScores[maxKey] || '';
            document.getElementById('max-score-month-title').textContent = MONTHS.find(m => m.key === monthKey).label;
            document.getElementById('max-score-input').value = currentMax;
            document.getElementById('max-score-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('max-score-input').focus(), 100);
        };
        document.getElementById('set-max-score-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const val = parseFloat(document.getElementById('max-score-input').value);
            if (val > 0) {
                // Ensure fresh data
                const freshData = await getSectionData(currentSectionId);
                if (!freshData) return;
                
                const maxKey = `${currentSchoolYear}_${currentMonthForMax}`;
                
                // Use precise update for maxScores to avoid overwriting map
                const updatePayload = {};
                updatePayload[`maxScores.${maxKey}`] = val;
                
                try {
                    await updateDoc(doc(db, getUserPath('sections'), currentSectionId), updatePayload);
                } catch(e) {
                    // Fallback create
                    freshData.maxScores[maxKey] = val;
                    await setDoc(doc(db, getUserPath('sections'), currentSectionId), freshData, { merge: true });
                }
                
                // Update local pointer for fast UI
                currentSectionData.maxScores[maxKey] = val;
                
                document.getElementById('max-score-modal').classList.add('hidden');
                loadDashboard(currentSectionId);
            }
        });

        window.openScoreModal = async (studentId, monthKey, name) => {
            const maxKey = `${currentSchoolYear}_${monthKey}`;
            const max = currentSectionData.maxScores[maxKey];
            if (!max) {
                alert(`Please set the Perfect Score for ${MONTHS.find(m => m.key === monthKey).label} first.`);
                return;
            }
            document.getElementById('score-modal').classList.remove('hidden');
            document.getElementById('score-student-id').value = studentId;
            document.getElementById('score-month-key').value = monthKey;
            document.getElementById('score-student-name').textContent = name;
            document.getElementById('score-month-label').textContent = MONTHS.find(m => m.key === monthKey).label;
            document.getElementById('score-perfect-display').textContent = max;

            const ref = doc(db, getUserPath('students'), studentId);
            const docSnap = await getDoc(ref);
            if (docSnap.exists()) {
                const s = docSnap.data();
                const raw = s.scores && s.scores[monthKey] !== undefined ? s.scores[monthKey] : '';
                document.getElementById('raw-score-input').value = raw;
                window.calculatePreview();
            }
            setTimeout(() => document.getElementById('raw-score-input').focus(), 100);
        };
        
        window.calculatePreview = () => {
            const raw = parseFloat(document.getElementById('raw-score-input').value);
            const max = parseFloat(document.getElementById('score-perfect-display').textContent);
            const preview = document.getElementById('grade-preview');
            if (isNaN(raw)) {
                preview.textContent = "1.0";
                preview.className = "text-4xl font-bold text-slate-300 comic-font";
                return;
            }
            let grade = 1 + ((raw / max) * 9);
            if (grade > 10) grade = 10;
            if (grade < 1) grade = 1;
            preview.textContent = Math.round(grade);
            if (grade >= 9) preview.className = "text-4xl font-bold text-emerald-500 comic-font";
            else if (grade >= 7.5) preview.className = "text-4xl font-bold text-blue-500 comic-font";
            else if (grade >= 5) preview.className = "text-4xl font-bold text-yellow-500 comic-font";
            else preview.className = "text-4xl font-bold text-red-500 comic-font";
        };
        
        document.getElementById('save-score-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sid = document.getElementById('score-student-id').value;
            const mkey = document.getElementById('score-month-key').value;
            const raw = document.getElementById('raw-score-input').value;
            if (raw !== '') {
                await updateStudentScore(sid, mkey, raw);
                // Note: Modal closing handled in updateStudentScore
            }
        });

        window.openNotesModal = async (studentId, studentName) => {
            document.getElementById('notes-student-id').value = studentId;
            document.getElementById('notes-student-name').textContent = studentName;
            const container = document.getElementById('notes-list-container');
            container.innerHTML = '<div class="text-center py-4 text-slate-400">Loading notes...</div>';
            document.getElementById('notes-modal').classList.remove('hidden');
            
            const docSnap = await getDoc(doc(db, getUserPath('students'), studentId));
            if (docSnap.exists()) {
                const s = docSnap.data();
                const notes = s.notes || {};
                let html = '';
                MONTHS.forEach(m => {
                    const baseKey = `${currentSchoolYear}_${m.key}`;
                    const valRead = notes[baseKey + '_reading'] || '';
                    const valWrite = notes[baseKey + '_writing'] || '';
                    html += `
                        <div class="bg-slate-50 p-3 rounded border border-slate-200">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-primary-100 text-primary-700 px-2 py-0.5 rounded text-xs font-bold uppercase">${m.label}</span>
                            </div>
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr>
                                        <th class="text-[10px] text-slate-400 uppercase text-left w-1/2 px-1 pb-1">Reading Notes</th>
                                        <th class="text-[10px] text-slate-400 uppercase text-left w-1/2 px-1 pb-1">Writing Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="px-1"><textarea name="note_${baseKey}_reading" class="w-full p-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-primary-500 outline-none min-h-[50px] resize-none" placeholder="Reading...">${valRead}</textarea></td>
                                        <td class="px-1"><textarea name="note_${baseKey}_writing" class="w-full p-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-primary-500 outline-none min-h-[50px] resize-none" placeholder="Writing...">${valWrite}</textarea></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        };
        
        document.getElementById('save-notes-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('notes-student-id').value;
            const textareas = document.querySelectorAll('#notes-list-container textarea');
            const notesUpdate = {};
            textareas.forEach(ta => {
                const key = ta.name.replace('note_', '');
                notesUpdate[key] = ta.value.trim();
            });
            await updateStudentNotes(studentId, notesUpdate);
            document.getElementById('notes-modal').classList.add('hidden');
            alert('Notes saved successfully!');
        });

        window.openEditStudentModal = (id, name, nickname) => {
            document.getElementById('edit-student-id').value = id;
            document.getElementById('edit-student-name').value = name;
            document.getElementById('edit-student-nickname').value = nickname;
            document.getElementById('edit-student-modal').classList.remove('hidden');
        };
        document.getElementById('edit-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-student-id').value;
            const name = document.getElementById('edit-student-name').value.trim();
            const nickname = document.getElementById('edit-student-nickname').value.trim();
            if (id && name) {
                await updateStudent(id, name, nickname);
                document.getElementById('edit-student-modal').classList.add('hidden');
                loadDashboard(currentSectionId);
            }
        });

        window.deleteStudent = (id) => deleteStudent(id);
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- Data Handling ---
        
        window.exportData = async () => {
            const sections = await getAllSections();
            const students = await getStudents(currentSectionId); // Export just current section or loop all?
            // To do a full backup, we need all students from all sections.
            const allStudentsSnapshot = await getDocs(collection(db, getUserPath('students')));
            const allStudents = [];
            allStudentsSnapshot.forEach(doc => allStudents.push(doc.data()));
            
            const data = { sections, students: allStudents };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'K3_Grading_Backup.json';
            a.click();
        };

        window.handleRestore = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.sections || !Array.isArray(data.sections) || !data.students || !Array.isArray(data.students)) {
                        alert("Invalid backup file format.");
                        return;
                    }
                    if (!confirm("WARNING: This will overwrite ALL cloud data with the backup. Are you sure?")) return;
                    
                    showLoading("Restoring Data...");

                    // 1. Wipe Sections (Wait for all to finish)
                    const secSnap = await getDocs(collection(db, getUserPath('sections')));
                    const deletePromises1 = [];
                    secSnap.forEach(d => deletePromises1.push(deleteDoc(d.ref)));
                    await Promise.all(deletePromises1);

                    // 2. Wipe Students (Wait for all to finish)
                    const stuSnap = await getDocs(collection(db, getUserPath('students')));
                    const deletePromises2 = [];
                    stuSnap.forEach(d => deletePromises2.push(deleteDoc(d.ref)));
                    await Promise.all(deletePromises2);
                    
                    // 3. Restore Sections
                    await batchCommit(data.sections, getUserPath('sections'));

                    // 4. Restore Students
                    await batchCommit(data.students, getUserPath('students'));
                    
                    hideLoading();
                    alert("Data restored successfully to Firebase! Reloading...");
                    location.reload();

                } catch (err) {
                    hideLoading();
                    console.error("Restore error:", err);
                    alert("Error processing backup file.");
                }
            };
            reader.readAsText(file);
        };
        
        // --- Print Logic ---
        
        window.printMonthReport = async (monthKey) => {
            const students = await getStudents(currentSectionId);
            const monthLabel = MONTHS.find(m => m.key === monthKey).label;
            const maxKey = `${currentSchoolYear}_${monthKey}`;
            const maxScore = currentSectionData.maxScores[maxKey] || 0;

            const printArea = document.getElementById('print-area');
            const mainContent = document.querySelector('main');
            const header = document.querySelector('header');
            const footer = document.querySelector('footer');
            const mainPrintHeader = document.getElementById('main-print-header'); 
            
            const monthColors = ['bg-rose-100','bg-fuchsia-100','bg-violet-100','bg-blue-100','bg-cyan-100','bg-emerald-100'];
            const monthIndex = MONTHS.findIndex(m => m.key === monthKey);
            const mColor = monthColors[monthIndex] || 'bg-gray-100';

            let logoHtml = '';
            if (cachedLogo) {
                logoHtml = `<img src="${cachedLogo}" style="height: 80px; width: auto; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;">`;
            }

            let html = `
                <div class="p-8 font-sans">
                    <div class="text-center mb-6 border-b-2 border-gray-100 pb-4">
                        ${logoHtml}
                        <h1 class="text-3xl font-bold">Neerada School</h1>
                        <h2 class="text-2xl font-bold mt-2">${currentSectionData.name} - ${monthLabel} Report</h2>
                        <p class="text-gray-500">English Subject ‚Ä¢ Perfect Score: ${maxScore} ‚Ä¢ ${currentSchoolYear}</p>
                    </div>
                    <table class="w-full border-collapse border border-gray-300 text-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 p-2 w-12 text-center bg-gray-200">#</th>
                                <th class="border border-gray-300 p-2 text-left bg-orange-100 text-orange-900">Student Name</th>
                                <th class="border border-gray-300 p-2 text-left w-32 bg-amber-100 text-amber-900">Nickname</th>
                                <th class="border border-gray-300 p-2 w-24 text-center ${mColor}">Raw Score</th>
                                <th class="border border-gray-300 p-2 w-24 text-center ${mColor}">Final Grade</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            students.forEach((s, idx) => {
                const raw = s.scores && s.scores[monthKey];
                const nick = s.nickname || '-';
                let rawDisplay = '-', gradeDisplay = '-';
                if (maxScore > 0 && raw !== undefined) {
                    rawDisplay = Math.round(raw);
                    let g = 1 + ((raw/maxScore)*9);
                    if(g>10)g=10; if(g<1)g=1;
                    gradeDisplay = Math.round(g);
                }
                html += `<tr>
                        <td class="border border-gray-300 p-2 text-center text-gray-500">${idx+1}</td>
                        <td class="border border-gray-300 p-2 font-medium">${s.name}</td>
                        <td class="border border-gray-300 p-2 text-gray-600">${nick}</td>
                        <td class="border border-gray-300 p-2 text-center">${rawDisplay}</td>
                        <td class="border border-gray-300 p-2 text-center font-bold">${gradeDisplay}</td>
                    </tr>`;
            });
            html += `</tbody></table>
                <div class="mt-8 pt-4 border-t border-slate-300 text-center text-slate-500 text-xs">
                    &copy; ${new Date().getFullYear()} Neerada School. All rights reserved.
                </div>
            </div>`;
            
            printArea.innerHTML = html;
            mainContent.classList.add('hidden');
            header.classList.add('hidden');
            footer.classList.add('hidden');
            if (mainPrintHeader) {
                mainPrintHeader.classList.remove('print-only');
                mainPrintHeader.classList.add('hidden');
            }
            printArea.classList.remove('hidden');
            window.print();
            
            printArea.classList.add('hidden');
            if (mainPrintHeader) {
                mainPrintHeader.classList.remove('hidden');
                mainPrintHeader.classList.add('print-only');
            }
            mainContent.classList.remove('hidden');
            header.classList.remove('hidden');
            footer.classList.remove('hidden');
        };

        // Initialize
        document.getElementById('school-year-select').addEventListener('change', window.changeSchoolYear);
        window.onload = initApp;
    </script>
</body>
</html>
